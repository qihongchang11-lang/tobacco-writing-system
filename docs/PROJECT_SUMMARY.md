# Tobacco Writing System - é¡¹ç›®å¼€å‘æ€»ç»“

> **æ›´æ–°æ—¶é—´**: 2025-11-06
> **å½“å‰çŠ¶æ€**: Phase 1 å®Œæˆ âœ…
> **ä¸‹ä¸€æ­¥**: è§„åˆ’ Phase 2 æ–¹å‘

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

### ç›®æ ‡
å°†è¾“å…¥ç¨¿ä»¶æ”¹å†™ä¸º**ä¸œæ–¹çƒŸè‰æŠ¥/ä¸­å›½çƒŸè‰æŠ¥é£æ ¼**ï¼Œå¹¶ä¿æŒæ•°å­—ã€æ—¥æœŸã€æœºæ„åç­‰**äº‹å®ä¸€è‡´æ€§**ã€‚

### æ ¸å¿ƒä»·å€¼
- âœ… **äº‹å®ä¿æŠ¤**: 100% ä¿æŒæ•°å­—å’Œæœºæ„åå‡†ç¡®æ€§
- âœ… **é£æ ¼è½¬æ¢**: è‡ªåŠ¨è½¬æ¢ä¸ºè§„èŒƒçš„çƒŸè‰æŠ¥æ–‡ä½“
- âœ… **æ ç›®åŒ¹é…**: æ™ºèƒ½è¯†åˆ«å¹¶åŒ¹é…åˆé€‚æ ç›®é£æ ¼
- âœ… **åˆè§„æ£€æŸ¥**: è‡ªåŠ¨æ£€æµ‹è¿è§„è¯æ±‡å’Œè¡¨è¿°

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿç»„ä»¶
```
â”œâ”€â”€ FastAPI åç«¯æœåŠ¡ (ç«¯å£ 8081)
â”œâ”€â”€ ConstraintDecoder (äº‹å®ä¿æŠ¤æ ¸å¿ƒ)
â”‚   â”œâ”€â”€ å®ä½“æå–ä¸å ä½ç¬¦æ›¿æ¢
â”‚   â”œâ”€â”€ ç™½åå•æœºæ„éªŒè¯
â”‚   â”œâ”€â”€ æ–°æ•°å­—æ£€æµ‹ä¸è­¦æŠ¥
â”‚   â””â”€â”€ æ³„æ¼æ£€æµ‹ä¸å…œåº•æœºåˆ¶
â”œâ”€â”€ BM25 çŸ¥è¯†æ£€ç´¢ (LRU ç¼“å­˜)
â”œâ”€â”€ æ ç›®è§„åˆ™å¼•æ“ (column_rules.yaml)
â””â”€â”€ DeepSeek API é›†æˆ
```

### å…³é”®æ–‡ä»¶ç»“æ„
```
tobacco-writing-pipeline/
â”œâ”€â”€ api_main.py                 # ä¸»APIæœåŠ¡
â”œâ”€â”€ config/
â”‚   â””â”€â”€ column_rules.yaml      # æ ç›®è§„åˆ™é…ç½®
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ constraint_decoder.py  # äº‹å®çº¦æŸè§£ç å™¨
â”‚   â””â”€â”€ knowledge_retriever.py # çŸ¥è¯†æ£€ç´¢ç»„ä»¶
â”œâ”€â”€ data/
â”‚   â””â”€â”€ knowledge/             # çŸ¥è¯†åº“æ–‡ä»¶
â”œâ”€â”€ docs/                      # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ PROJECT_BRIEF.md
â”‚   â”œâ”€â”€ STATUS.json
â”‚   â””â”€â”€ RUNBOOK.md
â”œâ”€â”€ .env                       # ç¯å¢ƒé…ç½®
â””â”€â”€ requirements.txt           # ä¾èµ–åŒ…
```

---

## âœ… Phase 1 å®Œæˆæƒ…å†µ

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯

#### 1. API æœåŠ¡çŠ¶æ€
- **æœåŠ¡ç«¯å£**: 8081
- **å¥åº·æ£€æŸ¥**: `http://localhost:8081/health`
- **APIçŠ¶æ€**: âœ… æ­£å¸¸è¿è¡Œ
- **æ¨¡å‹**: DeepSeek-chat (deepseek-chat)

#### 2. æ”¹å†™æµ‹è¯•ç»“æœ
```json
{
  "HTTP Status": 200,
  "å“åº”æ—¶é—´": "14.74ç§’",
  "æ€»ä½“è¯„åˆ†": 0.92,
  "äº‹å®ä¸€è‡´æ€§": 1.0,
  "é£æ ¼ä¸€è‡´æ€§": 0.9,
  "åˆè§„æ€§": 0.95
}
```

#### 3. å®¡è®¡å­—æ®µéªŒè¯
- **entities_locked**: âœ… æˆåŠŸé”å®š3ä¸ªæ•°å­— + 1ä¸ªæœºæ„
- **new_numbers_detected**: âœ… ç©ºæ•°ç»„ï¼ˆæ— æ–°å¢æ•°å­—ï¼‰
- **evidence**: âœ… è¿”å›3æ¡ç›¸å…³è¯æ®
- **needs_review**: falseï¼ˆæ— éœ€äººå·¥å®¡æ ¸ï¼‰

---

## âš™ï¸ ç³»ç»Ÿé…ç½®

### ç¯å¢ƒå˜é‡ (.env)
```bash
# DeepSeek API é…ç½®
OPENAI_API_KEY=sk-c8b34b714d3e409e82b894362975caab
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-chat

# åº”ç”¨é…ç½®
LOG_LEVEL=INFO
PORT=8081
```

### æ ç›®é…ç½® (config/column_rules.yaml)
```yaml
columns:
  - id: news_general
    name: è¦é—»
    types: ["è¡Œä¸šæ–°é—»","æ´»åŠ¨æŠ¥é“","ä¼šè®®æŠ¥é“"]

  - id: case_observation
    name: æ¡ˆä¾‹
    types: ["æ¡ˆä¾‹","æ¸ é“å®è·µ","å…¸å‹æŠ¥é“"]

  - id: policy_interpretation
    name: æ”¿ç­–è§£è¯»
    types: ["æ”¿ç­–å‘å¸ƒ","å…¬æ–‡å‘å¸ƒ","é€šçŸ¥å…¬å‘Š"]

  - id: economic_data
    name: ç»æµè¿è¡Œ
    types: ["æ•°æ®æŠ¥å‘Š","ç»Ÿè®¡åˆ†æ","ç»æµè¿è¡Œ"]
```

---

## ğŸš€ API ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨æœåŠ¡
```bash
cd ~/tobacco-writing-pipeline
.\.venv\Scripts\python.exe -m uvicorn api_main:app --host 0.0.0.0 --port 8081 --log-level info
```

### å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8081/health
```
**æœŸæœ›è¿”å›**:
```json
{
  "ok": true,
  "service": "tobacco-writing-system",
  "version": "1.0.0-phase1",
  "components": {"decoder": true, "retriever": true}
}
```

### æ”¹å†™è¯·æ±‚
```bash
curl -X POST http://localhost:8081/rewrite \
  -H "Content-Type: application/json" \
  --data-binary @smoke.json
```

**è¯·æ±‚ä½“ç¤ºä¾‹** (smoke.json):
```json
{
  "text": "è¿‘æ—¥ï¼Œå±±ä¸œçœçƒŸè‰ä¸“å–å±€å¬å¼€ä¼šè®®ï¼Œå¼ºè°ƒè¦æ·±å…¥å­¦ä¹ è´¯å½»å…šçš„äºŒåå¤§ç²¾ç¥ï¼Œå…¨é¢æ¨è¿›å·çƒŸè¥é”€é«˜è´¨é‡å‘å±•ã€‚ä»Šå¹´å‰ä¸‰å­£åº¦ï¼Œå…¨çœç´¯è®¡é”€å”®å·çƒŸ45.2ä¸‡ç®±ï¼ŒåŒæ¯”å¢é•¿8.5%ï¼Œå®ç°é”€å”®æ”¶å…¥123.6äº¿å…ƒã€‚ä¸‹ä¸€æ­¥ï¼Œå°†å›´ç»•å¸‚åœºéœ€æ±‚ï¼ŒæŒç»­ä¼˜åŒ–å“ç‰Œç»“æ„ï¼Œç¡®ä¿å®Œæˆå…¨å¹´ç›®æ ‡ä»»åŠ¡ã€‚",
  "column_id": "news_general",
  "options": {
    "return_evidence": true,
    "strict_mode": true
  }
}
```

---

## ğŸ“‹ æ•…éšœæ’æŸ¥æ‰‹å†Œ

### å¸¸è§é—®é¢˜

#### 1. ç«¯å£ 8081 è¢«å ç”¨
```bash
# æŸ¥æ‰¾å ç”¨è¿›ç¨‹
netstat -ano | findstr :8081
# æ€æ‰è¿›ç¨‹
taskkill /F /PID <è¿›ç¨‹ID>
```

#### 2. API Key é”™è¯¯
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `OPENAI_API_KEY`
- ç¡®ä¿æ²¡æœ‰å¤šä¸ª .env æ–‡ä»¶å†²çª
- é‡å¯æœåŠ¡è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ

#### 3. ä¾èµ–ç¼ºå¤±
```bash
.\.venv\Scripts\python.exe -m pip install -r requirements.txt
```

#### 4. æœåŠ¡æ— å“åº”
- æ£€æŸ¥æ—¥å¿—: `tail -f logs/api.err`
- ç¡®è®¤è™šæ‹Ÿç¯å¢ƒæ¿€æ´»
- éªŒè¯ Python ç‰ˆæœ¬ (éœ€è¦ 3.12+)

---

## ğŸ¯ Phase 2 è§„åˆ’é€‰é¡¹

### é€‰é¡¹ A: å†…å®¹è´¨é‡æå‡ ğŸ“
- **å®Œå–„æ ç›®è§„åˆ™**: è¡¥å……æ›´å¤šä¸œæ–¹çƒŸè‰æŠ¥æ ç›®é…ç½®
- **ä¼˜åŒ–æ”¹å†™æ¨¡æ¿**: æå‡ç‰¹å®šæ ç›®çš„æ”¹å†™è´¨é‡
- **é£æ ¼fine-tuning**: é’ˆå¯¹ä¸œæ–¹çƒŸè‰æŠ¥é£æ ¼è¿›ä¸€æ­¥ä¼˜åŒ–

### é€‰é¡¹ B: ç³»ç»ŸåŠŸèƒ½æ‰©å±• ğŸ”§
- **æ‰¹é‡å¤„ç†åŠŸèƒ½**: æ”¯æŒå¤šæ–‡ç« æ‰¹é‡æ”¹å†™
- **è´¨é‡è¯„ä¼°ç³»ç»Ÿ**: è‡ªåŠ¨è¯„åˆ†å’Œè¾¾æ ‡ç‡ç»Ÿè®¡
- **å†…å®¹å®¡æ ¸å·¥å…·**: å¢å¼ºåˆè§„æ€§æ£€æŸ¥

### é€‰é¡¹ C: ç”Ÿäº§åŒ–éƒ¨ç½² ğŸš€
- **Dockerå®¹å™¨åŒ–**: å‡†å¤‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- **Webç•Œé¢å¼€å‘**: ç”¨æˆ·å‹å¥½çš„å‰ç«¯ç•Œé¢
- **APIæ–‡æ¡£å®Œå–„**: OpenAPIè§„èŒƒå’Œä½¿ç”¨æŒ‡å—

### é€‰é¡¹ D: æ•°æ®å‡†å¤‡ä¸æµ‹è¯• ğŸ“Š
- **çœŸå®æ ·æœ¬æ”¶é›†**: å‡†å¤‡ä¸œæ–¹çƒŸè‰æŠ¥çœŸå®æ–‡ç« æ ·æœ¬
- **æ‰¹é‡æµ‹è¯•æ‰§è¡Œ**: å¤§è§„æ¨¡æ”¹å†™è´¨é‡éªŒè¯
- **æ€§èƒ½ä¼˜åŒ–**: å“åº”æ—¶é—´å’Œå‡†ç¡®ç‡ä¼˜åŒ–

---

## ğŸ“ˆ æˆåŠŸéªŒè¯æ•°æ®

### æµ‹è¯•æ¡ˆä¾‹
**è¾“å…¥**: å±±ä¸œçœçƒŸè‰ä¸“å–å±€ä¼šè®®æ–°é—»ç¨¿
**è¾“å‡º**: ä¸œæ–¹çƒŸè‰æŠ¥ç»æµè¿è¡Œæ ç›®æ ‡å‡†æ ¼å¼

### è´¨é‡æŒ‡æ ‡
| æŒ‡æ ‡ | åˆ†æ•° | çŠ¶æ€ |
|------|------|------|
| äº‹å®ä¸€è‡´æ€§ | 1.0/1.0 | âœ… å®Œç¾ |
| é£æ ¼ä¸€è‡´æ€§ | 0.9/1.0 | âœ… ä¼˜ç§€ |
| åˆè§„æ€§æ£€æŸ¥ | 0.95/1.0 | âœ… ä¼˜ç§€ |
| æ€»ä½“è¯„åˆ† | 0.92/1.0 | âœ… ä¼˜ç§€ |

### æŠ€æœ¯æŒ‡æ ‡
- **å“åº”æ—¶é—´**: 14.74ç§’
- **å®ä½“ä¿æŠ¤**: 100% æˆåŠŸ
- **æ ç›®è¯†åˆ«**: å‡†ç¡®åŒ¹é…"ç»æµè¿è¡Œ"
- **è¯æ®æ£€ç´¢**: 3æ¡ç›¸å…³çŸ¥è¯†

---

## ğŸ”— å¿«é€Ÿæ¢å¤å¼€å‘

### 1. ç¯å¢ƒæ£€æŸ¥
```bash
# ç¡®è®¤æœåŠ¡çŠ¶æ€
curl -s http://localhost:8081/health

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep uvicorn
```

### 2. é‡å¯æœåŠ¡
```bash
cd ~/tobacco-writing-pipeline
taskkill /F /IM python.exe 2>nul
.\.venv\Scripts\python.exe -m uvicorn api_main:app --host 0.0.0.0 --port 8081 --log-level info
```

### 3. æµ‹è¯•éªŒè¯
```bash
curl -X POST http://localhost:8081/rewrite \
  -H "Content-Type: application/json" \
  --data-binary @smoke.json
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å…³é”®é…ç½®
- **Python**: 3.12.10
- **APIæä¾›å•†**: DeepSeek
- **æœåŠ¡ç«¯å£**: 8081
- **æ—¥å¿—ä½ç½®**: `logs/api.err`, `logs/api.out`

### é‡è¦æç¤º
1. ç¡®ä¿ä½¿ç”¨é¡¹ç›®å†…çš„è™šæ‹Ÿç¯å¢ƒ `.venv`
2. DeepSeek API Key å·²é›†æˆä¸”æœ‰æ•ˆ
3. æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯é€šè¿‡
4. å¯ä»¥ç›´æ¥è¿›å…¥ Phase 2 å¼€å‘

---

*ğŸ‰ Phase 1 åœ†æ»¡å®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªè¿›å…¥ä¸‹ä¸€é˜¶æ®µå¼€å‘ï¼*