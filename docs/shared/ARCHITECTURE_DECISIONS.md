# 技术决策记录 (ADR - Architecture Decision Records)

> **文档目标**：记录重要技术决策的背景、选项、决策理由和后果，为未来类似决策提供参考。

---

## ADR-001: 仓库组织策略选择

**状态**: 已采纳
**日期**: 2025-11-16
**决策者**: 开发团队 + 用户

### 背景
需要将tobacco-writing-pipeline仓库中的三个系统（东方烟草报、新华财经、CNIPA专利）同步到GitHub，便于与Codex协作。

### 决策
采用**统一仓库策略**，保持单一仓库包含所有系统。

### 考虑的选项
1. **多仓库拆分**：为每个系统创建独立仓库
2. **统一仓库 + 目录拆分**：在单仓库内按系统划分目录
3. **统一仓库 + 轻量重组**：保持代码结构，仅重组文档

### 决策理由
- ✅ 保留完整Git历史和提交记录
- ✅ 避免版本同步复杂性
- ✅ 简化协作流程，便于跨系统参考
- ✅ Codex能获得项目完整上下文
- ✅ 可能的代码模块共享（constraint_decoder等）

### 拒绝理由
- ❌ 多仓库会丢失提交历史
- ❌ 目录拆分会破坏Python导入路径

### 后果
**正面影响**：
- 协作效率显著提升
- Git历史完整保留
- 便于统一文档和配置管理

**负面影响**：
- 根目录相对复杂，需要清晰的内部组织
- 单仓库体积较大

### 合规性
此决策需要在代码质量、文档组织等方面额外投入以抵消负面影响。

---

## ADR-002: Python代码目录结构保持策略

**状态**: 已采纳
**日期**: 2025-11-16
**决策者**: 开发团队

### 背景
在统一仓库重组过程中，需要决定是否移动Python源码到子目录以获得更清晰的组织结构。

### 决策
**保持所有Python代码在原目录结构**，不移动core/、agents/、knowledge_base/等模块。

### 考虑的选项
1. **移动到系统子目录**：如news-system/core/、patent-system/src/
2. **保持现有结构**：所有代码保持在根目录或原位置
3. **渐进式重构**：先移动文档，后续再处理代码

### 决策理由
- ✅ 避免破坏现有`from agents import`等导入语句
- ✅ 确保代码零破坏性变更
- ✅ 快速实施，减少风险
- ✅ 保持开发环境的一致性

### 拒绝理由
- ❌ 移动会导致大量导入路径失效
- ❌ 需要修改PYTHONPATH或重写import语句
- ❌ 增加实施复杂度和风险

### 后果
**正面影响**：
- 代码继续正常运行
- 开发者无需调整开发环境
- 实施风险降到最低

**负面影响**：
- 根目录文件较多，组织略显混乱
- 系统边界在代码层面不够清晰

### 合规性
通过文档组织和README导航来缓解代码目录混乱的问题。

---

## ADR-003: 双端口独立服务架构

**状态**: 已实施
**日期**: 2025年初实施，本次确认延续
**决策者**: 开发团队

### 背景
需要决定新闻改写系统和专利系统的部署架构：单一服务切换模式 vs 独立服务模式。

### 决策
采用**双端口独立FastAPI服务**架构：
- 新闻系统：端口8081
- 专利系统：端口8082

### 考虑的选项
1. **单端口路径路由**：/news/* 和 /patent/* 路径区分
2. **双端口独立服务**：完全独立的FastAPI实例
3. **微服务容器化**：Docker + API Gateway

### 决策理由
- ✅ 系统功能完全解耦，降低相互影响
- ✅ 便于独立部署、扩展和维护
- ✅ 故障隔离，一个系统问题不影响另一个
- ✅ 开发团队可并行工作
- ✅ 便于A/B测试和灰度发布

### 后果
**正面影响**：
- 高度的系统独立性
- 便于性能优化和监控
- 支持独立的部署策略

**负面影响**：
- 需要统一监控和日志管理
- 端口管理相对复杂
- 共享组件需要额外设计

### 合规性
通过统一的启动脚本和监控方案来管理多端口复杂性。

---

## ADR-004: 文档分层组织策略

**状态**: 已采纳
**日期**: 2025-11-16
**决策者**: 开发团队

### 背景
仓库中累积了大量文档文件（.md/.txt/.docx/.pdf），散布在根目录，影响项目可读性。

### 决策
采用**按职责分层的文档组织**：
- `docs/shared/` - 跨系统通用文档
- `docs/news-system-docs/` - 新闻系统专属文档
- `docs/patent/` - 专利系统文档

### 考虑的选项
1. **按文件类型分类**：docs/markdown/、docs/samples/等
2. **按系统职责分类**：如上所述
3. **按开发阶段分类**：docs/design/、docs/implementation/等
4. **保持现状**：文档继续散布在根目录

### 决策理由
- ✅ 便于新协作者快速定位相关文档
- ✅ 系统边界清晰，降低认知负担
- ✅ 支持独立的文档维护流程
- ✅ 便于文档版本管理和更新

### 拒绝理由
- ❌ 按类型分类会导致相关文档分散
- ❌ 按阶段分类对新人不够友好

### 后果
**正面影响**：
- 显著提升文档可发现性
- 新协作者上手更快
- 文档维护更有序

**负面影响**：
- 需要维护文档分类的一致性
- 跨系统文档的分类可能存在争议

### 合规性
在每个子目录添加README.md说明分类标准和文档索引。

---

## ADR-005: Git历史保护策略

**状态**: 已采纳
**日期**: 2025-11-16
**决策者**: 开发团队 + 用户强烈要求

### 背景
在文档重组过程中，需要决定是否保留文件的Git提交历史。

### 决策
**强制保护Git历史**，使用`git mv`命令移动所有版本控制的文件。

### 考虑的选项
1. **复制+删除**：cp新位置，rm旧文件，git add新文件
2. **git mv命令**：保留完整历史轨迹
3. **混合策略**：重要文件用git mv，临时文件可复制

### 决策理由
- ✅ Git历史是项目重要资产，不可丢失
- ✅ 便于追溯文档演进和变更原因
- ✅ 支持blame和历史搜索功能
- ✅ 符合开源项目最佳实践

### 后果
**正面影响**：
- 完整的项目历史得以保留
- 支持精确的变更追溯
- 提升项目专业度

**负面影响**：
- 实施略复杂，需要逐个处理
- 未跟踪文件无法保留历史

### 合规性
对于未跟踪的文件采用复制+删除策略，并在提交信息中说明来源。

---

## 决策原则总结

基于以上决策记录，提炼出以下技术决策原则，用于指导未来决策：

### 1. 用户价值优先原则
- 技术方案必须以用户需求为出发点
- 避免为了技术完美而牺牲用户体验
- 重大决策前征求用户意见

### 2. 最小破坏原则
- 优先选择对现有系统影响最小的方案
- 渐进式改进优于激进重构
- 保持向后兼容性

### 3. 历史保护原则
- Git历史是重要资产，必须保护
- 使用工具而非手动操作来保留历史
- 重要变更要有详细的提交信息

### 4. 分离关注点原则
- 按职责而非技术特征组织
- 系统间保持松耦合
- 便于独立开发和部署

### 5. 文档驱动原则
- 重要决策必须文档化
- 提供清晰的导航和索引
- 定期更新和维护文档

---

**文档版本**：v1.0
**最后更新**：2025-11-16
**维护者**：项目核心团队
**审核周期**：重大决策后及时更新，季度回顾